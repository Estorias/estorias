<!DOCTYPE html>
<html lang="pt-BR" data-theme="onenari">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Mapa (MP)</title><link rel="icon" type="image/x-icon" href="img/logo.ico">
    <!-- Scripts do Firebase (v8, conforme seu arquivo original) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root, [data-theme='onenari'] {
            --font-main: 'Cinzel', serif;
            --color-bg-primary: #0a192f;
            --color-bg-secondary: #172a46;
            --color-bg-tertiary: #0f223d;
            --color-text-primary: #ccd6f6;
            --color-text-secondary: #8892b0;
            --color-accent: #64ffda;
            --color-border: #233554;
            --color-red: #e64966;
            --color-green: #64ffda;
            --color-yellow: #ffca86;
        }
        /* Layout de 2 colunas */
        html, body {
            height: 100%;
            overflow: hidden; /* Previne scroll da página inteira */
        }
        body {
            font-family: var(--font-main);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            display: flex;
        }
        #main-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .bg-primary { background-color: var(--color-bg-primary); }
        .bg-secondary { background-color: var(--color-bg-secondary); }
        .bg-tertiary { background-color: var(--color-bg-tertiary); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-accent { color: var(--color-accent); }
        .border-color { border-color: var(--color-border); }
        
        input, textarea {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--color-accent); }
        
        .gm-tab-button.active {
            border-color: var(--color-accent);
            color: var(--color-accent);
            background-color: var(--color-bg-secondary);
        }
        .gm-tab-button { transition: color 0.2s, border-color 0.2s, background-color 0.2s; }
        .gm-tab-button:hover { color: var(--color-accent); }

        .btn { padding: 0.5rem 1rem; border-radius: 4px; font-weight: bold; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: var(--color-accent); color: var(--color-bg-primary); }
        .btn-primary:hover { background-color: #52d9bc; }
        .btn-secondary { background-color: var(--color-bg-tertiary); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background-color: var(--color-border); }
        .btn-danger { background-color: var(--color-red); color: var(--color-bg-primary); }
        .btn-danger:hover { opacity: 0.9; }

        .modal-overlay { position: fixed; inset: 0; z-index: 110; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; }
        .modal-container { background-color: var(--color-bg-primary); width: 90%; display: flex; flex-direction: column; border: 2px solid var(--color-border); border-radius: 8px; }
        
        /* Painel Lateral (Sempre Aberto) */
        #gm-panel {
            width: 384px; /* w-96 */
            height: 100vh;
            background-color: var(--color-bg-primary);
            border-right: 2px solid var(--color-border);
            z-index: 120;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .gm-panel-header { padding: 1rem; border-bottom: 2px solid var(--color-border); font-size: 1.5rem; color: var(--color-accent); }
        .gm-panel-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .gm-panel-tabs { border-bottom: 2px solid var(--color-border); flex-shrink: 0; }
        .gm-tab-content { overflow-y: auto; flex-grow: 1; padding: 1rem; }
        .gm-player-card { background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .gm-player-info { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .gm-player-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .gm-player-name { font-size: 1.2rem; font-weight: bold; }
        .gm-control-btn { background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .gm-control-btn:hover { background-color: var(--color-border); }
        #gm-condition-modal .modal-container { max-width: 500px; max-height: 80vh; }
        #gm-condition-list { overflow-y: auto; max-height: 60vh; }
        .custom-checkbox:checked + label { color: var(--color-accent); }
        
        /* CORREÇÃO: Overflow hidden para não brigar com o Transform do Pan */
        #map-viewport { flex-grow: 1; overflow: hidden; background-color: var(--color-bg-tertiary); cursor: grab; position: relative; }
        
        #map-container { 
            position: relative; 
            width: 1000px; 
            height: 1000px; 
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            /* Adicionado para o Pan/Zoom */
            transform-origin: 0 0;
            transition: transform 0.05s linear; /* Mais rápido para arrastar sem lag */
        }
        #map-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(to right, var(--color-border) 1px, transparent 1px), linear-gradient(to bottom, var(--color-border) 1px, transparent 1px); background-size: 50px 50px; z-index: 1; }
        #map-tokens { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .player-token { position: absolute; background-size: cover; background-position: center; border-radius: 50%; border: 3px solid var(--color-accent); cursor: grab; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; transition: width 0.2s, height 0.2s, box-shadow 0.2s; }
        .player-token:active { cursor: grabbing; z-index: 10; }
        .token-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; }
        #map-bg-adjust-modal .modal-container { max-width: 80vw; max-height: 90vh; }
        #map-bg-preview-container { width: 600px; height: 600px; overflow: hidden; position: relative; border: 2px dashed var(--color-border); margin: auto; }
        #map-bg-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: fill; }
        #token-context-menu { display: none; position: fixed; z-index: 1000; background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: 4px; padding: 0.5rem; }
        #token-context-menu button { display: block; width: 100%; text-align: left; padding: 0.5rem; font-size: 0.9rem; }
        #token-context-menu button:hover { background-color: var(--color-bg-tertiary); }
        #token-context-menu hr { border-top: 1px solid var(--color-border); margin: 0.5rem 0; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; border: none; cursor: pointer; width: 100%; height: 24px;}
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid var(--color-border); }
        input[type="color"]::-moz-color-swatch { border-radius: 4px; border: 1px solid var(--color-border); }
        .token-hp-bar-container { position: absolute; top: -12px; left: 10%; width: 80%; height: 8px; background-color: rgba(0,0,0,0.7); border: 1px solid #000; border-radius: 4px; overflow: hidden; }
        .token-hp-bar { height: 100%; width: 100%; background-color: var(--color-red); transition: width 0.3s ease; }

        /* NOVO: CSS para o Ping do Mestre */
        .map-ping-target {
            position: absolute;
            width: 50px; /* Tamanho de 1 grid */
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--color-accent);
            background-color: rgba(100, 255, 218, 0.2);
            box-shadow: 0 0 15px var(--color-accent), 0 0 20px var(--color-accent) inset;
            transform: translate(-50%, -50%); /* Centraliza no clique */
            z-index: 999;
            pointer-events: none; /* Permite clicar através dele */
            animation: ping-animation 8s ease-out forwards;
        }
        .map-ping-target::before, .map-ping-target::after {
            content: '';
            position: absolute;
            background-color: var(--color-accent);
        }
        .map-ping-target::before { /* Linha vertical */
            width: 3px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }
        .map-ping-target::after { /* Linha horizontal */
            width: 100%;
            height: 3px;
            top: 50%;
            transform: translateY(-50%);
        }
        @keyframes ping-animation {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            10% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        /* Mensagem de Login */
        #firebase-login-prompt {
            display: none; /* Oculto por padrão */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Layout Principal (Visível após login) -->
    <div id="main-layout">
        <!-- Painel Lateral Fixo -->
        <div id="gm-panel">
            <div class="gm-panel-header">
                <span>Ferramentas do Mestre</span>
            </div>
            <div class="gm-panel-content">
                <div class="gm-panel-tabs">
                    <nav class="-mb-px flex space-x-2" aria-label="GM Tabs">
                        <button onclick="switchGmTab(event, 'gm-players-tab')" class="gm-tab-button active whitespace-nowrap py-2 px-3 border-b-2 border-transparent font-medium text-sm text-secondary">Jogadores</button>
                        <button onclick="switchGmTab(event, 'gm-map-tab')" class="gm-tab-button whitespace-nowrap py-2 px-3 border-b-2 border-transparent font-medium text-sm text-secondary">Mapa</button>
                    </nav>
                </div>
                <div id="gm-players-tab" class="gm-tab-content active">
                    <h3 class="text-lg font-bold text-primary mb-4">Jogadores Online</h3>
                    <div id="gm-player-list">
                        <p class="text-secondary animate-pulse">Carregando...</p>
                    </div>
                </div>
                <div id="gm-map-tab" class="gm-tab-content">
                    <h3 class="text-lg font-bold text-primary mb-4">Controles do Mapa</h3>
                    <div class="space-y-4">
                        <button id="add-token-btn" class="btn btn-secondary w-full py-2">Adicionar Token Genérico</button>
                        <button id="change-bg-btn" class="btn btn-secondary w-full py-2">Alterar Fundo do Mapa</button>
                        <button id="new-map-btn" class="btn btn-danger w-full py-2 mt-8">Novo Mapa em Branco</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área do Mapa (Visível por padrão) -->
        <div id="map-main-area">
            <div id="map-toolbar">
                <span class="text-xl text-accent font-bold">Mapa da Sessão</span>
                <input type="file" id="map-bg-upload" class="hidden" accept="image/*">
            </div>
            <div id="map-viewport">
                <div id="map-container">
                    <div id="map-grid"></div>
                    <div id="map-tokens"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensagem de "Faça Login" (Oculta por padrão) -->
    <div id="firebase-login-prompt">
        <h1 class="text-3xl font-bold text-accent mb-4">Mapa Desconectado</h1>
        <p class="text-secondary text-lg max-w-md">
            Faça login em uma sessão pela Ficha do Player (`fp.html`) ou pelo Painel do Mestre (`tc.html`) em outra aba para ativar este mapa.
        </p>
    </div>


    <!-- Modals -->
    <div id="gm-condition-modal" class="modal-overlay">
        <div class="modal-container bg-secondary p-4 rounded-lg shadow-lg">
            <h3 id="gm-condition-modal-title" class="font-bold text-xl text-accent mb-4">Atribuir Condições</h3>
            <div id="gm-condition-list" class="space-y-2 p-2"></div>
            <div class="flex justify-end gap-4 mt-4">
                <button id="gm-condition-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="gm-condition-save" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="map-bg-source-modal" class="modal-overlay">
         <div class="modal-container bg-secondary p-6 rounded-lg shadow-lg max-w-sm text-center">
            <h3 class="text-2xl text-accent mb-4">Escolher Fundo do Mapa</h3>
            <p class="text-secondary mb-6">De onde você quer carregar a imagem?</p>
            <div class="flex justify-center gap-4 mt-4">
                <button id="map-bg-from-computer" class="btn btn-primary py-2 px-6">Computador</button>
            </div>
        </div>
    </div>
    <div id="map-bg-adjust-modal" class="modal-overlay">
        <div class="modal-container bg-secondary p-4 rounded-lg shadow-lg">
            <h3 class="text-xl text-accent mb-4">Ajustar Fundo e Tamanho do Mapa</h3>
            <div class="flex items-center justify-center gap-4 mb-4">
                <div>
                    <label for="map-width-input" class="text-sm text-secondary">Largura (px)</label>
                    <input type="number" id="map-width-input" value="1000" class="w-24 text-center rounded-md p-1">
                </div>
                 <div>
                    <label for="map-height-input" class="text-sm text-secondary">Altura (px)</label>
                    <input type="number" id="map-height-input" value="1000" class="w-24 text-center rounded-md p-1">
                </div>
            </div>
            <div id="map-bg-preview-container">
                <img id="map-bg-preview" src="">
            </div>
             <div class="flex justify-end gap-4 mt-4">
                <button id="map-bg-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="map-bg-confirm" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="generic-token-modal" class="modal-overlay">
        <div class="modal-container bg-secondary p-6 rounded-lg shadow-lg max-w-md">
            <h3 class="text-2xl text-accent mb-4">Criar Token Genérico</h3>
            <div class="space-y-4">
                <div>
                    <label for="token-name-input" class="text-sm text-secondary">Nome do Token</label>
                    <input type="text" id="token-name-input" class="w-full p-2 rounded-md">
                </div>
                <div>
                    <label class="text-sm text-secondary">Imagem do Token</label>
                    <input type="file" id="token-image-upload" class="hidden" accept="image/*">
                    <button onclick="document.getElementById('token-image-upload').click()" class="btn btn-secondary w-full">Carregar Imagem</button>
                    <img id="token-image-preview" src="" class="hidden w-24 h-24 mx-auto mt-2 rounded-full object-cover border-2 border-color">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label for="token-current-hp-input" class="text-sm text-secondary">Vida Atual</label>
                        <input type="number" id="token-current-hp-input" value="10" class="w-full p-2 text-center rounded-md">
                    </div>
                    <div class="flex-1">
                        <label for="token-max-hp-input" class="text-sm text-secondary">Vida Máxima</label>
                        <input type="number" id="token-max-hp-input" value="10" class="w-full p-2 text-center rounded-md">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="generic-token-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="generic-token-confirm" class="btn btn-primary">Criar Token</button>
            </div>
        </div>
    </div>
    <div id="token-image-adjust-modal" class="modal-overlay">
        <div class="modal-container bg-secondary p-4 rounded-lg shadow-lg max-w-lg">
            <h3 class="text-xl text-accent mb-4">Ajustar Imagem do Token</h3>
            <div class="w-full h-64 md:h-96">
                <img id="token-cropper-image" src="">
            </div>
            <div class="flex justify-end gap-4 mt-4">
                <button id="token-image-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="token-image-confirm" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="token-context-menu">
        <button id="increase-token-size-btn">Aumentar Tamanho (+)</button>
        <button id="decrease-token-size-btn">Diminuir Tamanho (-)</button>
        <hr>
        <div class="flex items-center justify-between p-1">
            <label for="token-color-input" class="text-sm text-secondary">Cor da Borda</label>
            <input type="color" id="token-color-input">
        </div>
        <hr id="token-hp-separator" class="hidden">
        <div id="token-hp-editor" class="hidden p-1 space-y-2">
            <label class="text-sm text-secondary">Vida do Token</label>
            <div class="flex items-center gap-2">
                <input type="number" id="token-context-current-hp" class="w-16 p-1 text-center rounded">
                <span>/</span>
                <input type="number" id="token-context-max-hp" class="w-16 p-1 text-center rounded">
            </div>
            <button id="token-context-save-hp" class="btn btn-primary w-full text-sm py-1">Salvar Vida</button>
        </div>
        <hr>
        <button id="remove-token-btn" class="text-red-400">Remover Token</button>
    </div>
    
    <script>
        // --- INICIALIZAÇÃO DO FIREBASE ---
        let db;
        let playersCollection;
        let mapsCollectionRef;
        let mapDocRef;

        // --- DATA ---
        const allConditions = {
            'protegido': { name: 'Protegido (x)', type: 'bonus' }, 'vantagem': { name: 'Vantagem', type: 'bonus' }, 'inspirado': { name: 'Inspirado', type: 'bonus' }, 'focado': { name: 'Focado', type: 'bonus' }, 'fortalecido': { name: 'Fortalecido', type: 'bonus' }, 'impetuoso': { name: 'Impetuoso', type: 'bonus' }, 'agilizado': { name: 'Agilizado', type: 'bonus' }, 'preparado': { name: 'Preparado', type: 'bonus' }, 'revitalizado': { name: 'Revitalizado', type: 'bonus' }, 'motivado': { name: 'Motivado', type: 'bonus' }, 'destemido': { name: 'Destemido', type: 'bonus' }, 'vulneravel': { name: 'Vulnerável (x)', type: 'onus' }, 'desmotivado': { name: 'Desmotivado', type: 'onus' }, 'enfraquecido': { name: 'Enfraquecido', type: 'onus' }, 'lento': { name: 'Lento', type: 'onus' }, 'desvantagem': { name: 'Desvantagem', type: 'onus' }, 'em-apuros': { name: 'Em apuros', type: 'onus' }, 'preso': { name: 'Preso', type: 'onus' }, 'cansado': { name: 'Cansado', type: 'onus' }, 'desorientado': { name: 'Desorientado', type: 'onus' }, 'assustado': { name: 'Assustado', type: 'onus' }, 'ferido': { name: 'Ferido', type: 'onus' }, 'baixa-visibilidade': { name: 'Baixa Visibilidade', type: 'onus' },
        };
        
        // --- GLOBAL STATE ---
        let unsubscribeMapListener = null;
        let draggedToken = null;
        let highestZIndex = 151;
        let cropper = null;
        let processedTokenImageData = null;

        // --- GLOBAL STATE para Pan & Zoom ---
        let mapScale = 1;
        let mapTranslateX = 0;
        let mapTranslateY = 0;
        let isPanning = false;
        let lastPanX = 0;
        let lastPanY = 0;

        function checkFirebaseConfig() {
            const savedConfig = localStorage.getItem('rpg_firebase_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    initializeFirebase(config);
                    document.getElementById('main-layout').style.display = 'flex';
                    document.getElementById('firebase-login-prompt').style.display = 'none';
                } catch (e) {
                    console.error("Configuração salva inválida", e);
                    showLoginPrompt();
                }
            } else {
                showLoginPrompt();
            }
        }

        function initializeFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
            } catch(e) { console.error("Erro ao inicializar o Firebase: ", e); }
            
            db = firebase.firestore();
            playersCollection = db.collection('players');
            mapsCollectionRef = db.collection('maps');
            mapDocRef = db.collection('maps').doc('main_map');

            console.log("MP Conectado via Storage!");

            listenForMapChanges();
            listenForOnlinePlayers();
        }

        function showLoginPrompt() {
            document.getElementById('main-layout').style.display = 'none';
            document.getElementById('firebase-login-prompt').style.display = 'flex';
        }

        // --- FUNÇÕES DE PAN & ZOOM ---
        function updateMapTransform() {
            const mapContainer = document.getElementById('map-container');
            if(mapContainer) {
                mapContainer.style.transform = `translate(${mapTranslateX}px, ${mapTranslateY}px) scale(${mapScale})`;
            }
        }

        function handleMapZoom(e) {
            e.preventDefault(); 
            
            const viewport = document.getElementById('map-viewport');
            const rect = viewport.getBoundingClientRect();
            
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const mapMouseX = (mouseX - mapTranslateX) / mapScale;
            const mapMouseY = (mouseY - mapTranslateY) / mapScale;

            const zoomDirection = e.deltaY > 0 ? -1 : 1; 
            const zoomAmount = 0.1;
            const newScale = Math.min(Math.max(mapScale + zoomDirection * zoomAmount, 0.3), 5); 

            mapTranslateX = mouseX - mapMouseX * newScale;
            mapTranslateY = mouseY - mapMouseY * newScale;
            mapScale = newScale;

            updateMapTransform();
        }

        function handlePanStart(e) {
            if (e.target.closest('.player-token') || e.button !== 0) return;

            e.preventDefault();
            isPanning = true;
            lastPanX = e.clientX;
            lastPanY = e.clientY;
            const viewport = document.getElementById('map-viewport');
            viewport.style.cursor = 'grabbing'; 
        }

        function handlePanMove(e) {
            if (!isPanning) return;
            e.preventDefault();

            const dx = e.clientX - lastPanX;
            const dy = e.clientY - lastPanY;

            mapTranslateX += dx;
            mapTranslateY += dy;

            lastPanX = e.clientX;
            lastPanY = e.clientY;

            updateMapTransform();
        }

        function handlePanEnd(e) {
            if (isPanning) {
                isPanning = false;
                const viewport = document.getElementById('map-viewport');
                viewport.style.cursor = 'grab'; 
            }
        }

        function handleMapPing(e) {
            if (e.target.closest('.player-token')) return;
            e.preventDefault();

            const viewport = document.getElementById('map-viewport');
            const rect = viewport.getBoundingClientRect();

            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const pingX = (mouseX - mapTranslateX) / mapScale;
            const pingY = (mouseY - mapTranslateY) / mapScale;

            const pingEl = document.createElement('div');
            pingEl.className = 'map-ping-target';
            pingEl.style.left = `${pingX}px`;
            pingEl.style.top = `${pingY}px`;

            document.getElementById('map-tokens').appendChild(pingEl);

            setTimeout(() => {
                pingEl.remove();
            }, 8000);
        }

        function bringToFront(element) {
            highestZIndex++;
            element.style.zIndex = highestZIndex;
        }

        async function createNewMap() {
            if (confirm("Tem certeza que deseja apagar TODOS os mapas e dados de mapa? Esta ação é irreversível e afetará todos os usuários.")) {
                try {
                    const querySnapshot = await mapsCollectionRef.get();
                    if (!querySnapshot.empty) {
                        const batch = db.batch();
                        querySnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    await mapDocRef.set({ width: 1000, height: 1000, background: { src: '', x: 0, y: 0 }, tokens: {}, active: true });
                } catch (error) { console.error("Erro ao criar novo mapa:", error); }
            }
        }

        function openMapBgSourceModal() { document.getElementById('map-bg-source-modal').style.display = 'flex'; bringToFront(document.getElementById('map-bg-source-modal')); }
        function closeMapBgSourceModal() { document.getElementById('map-bg-source-modal').style.display = 'none'; }
        function openMapBgAdjustModal(imageSrc) { document.getElementById('map-bg-preview').src = imageSrc; document.getElementById('map-bg-adjust-modal').style.display = 'flex'; bringToFront(document.getElementById('map-bg-adjust-modal')); }
        
        function handleMapBackgroundUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => openMapBgAdjustModal(e.target.result);
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function confirmMapBg() {
            mapDocRef.update({ 'background.src': document.getElementById('map-bg-preview').src, 'width': parseInt(document.getElementById('map-width-input').value), 'height': parseInt(document.getElementById('map-height-input').value) });
            document.getElementById('map-bg-adjust-modal').style.display = 'none';
        }

        function cancelMapBg() { document.getElementById('map-bg-adjust-modal').style.display = 'none'; }
        
        function openGenericTokenModal() {
            document.getElementById('token-name-input').value = 'Novo Token';
            document.getElementById('token-current-hp-input').value = 10;
            document.getElementById('token-max-hp-input').value = 10;
            document.getElementById('token-image-preview').src = '';
            document.getElementById('token-image-preview').classList.add('hidden');
            processedTokenImageData = null;
            const modal = document.getElementById('generic-token-modal');
            modal.style.display = 'flex';
            bringToFront(modal);
        }
        
        function handleTokenImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const image = document.getElementById('token-cropper-image');
                image.src = e.target.result;
                const modal = document.getElementById('token-image-adjust-modal');
                modal.style.display = 'flex';
                bringToFront(modal);
                
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1, });
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }
        
        function confirmTokenImageCrop() {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 150, height: 150 });
            processedTokenImageData = canvas.toDataURL('image/jpeg', 0.7); 
            
            const preview = document.getElementById('token-image-preview');
            preview.src = processedTokenImageData;
            preview.classList.remove('hidden');
            
            closeTokenImageAdjustModal();
        }
        
        function closeTokenImageAdjustModal() {
            if (cropper) cropper.destroy();
            cropper = null;
            document.getElementById('token-image-adjust-modal').style.display = 'none';
        }
        
        async function createGenericToken() {
            const tokenId = `token_${Date.now()}`;
            const tokenData = {
                name: document.getElementById('token-name-input').value || 'Token',
                avatar: processedTokenImageData || 'https://placehold.co/150x150/cccccc/333333?text=?',
                x: 0, y: 0, size: 1, color: '#64ffda',
                currentHp: parseInt(document.getElementById('token-current-hp-input').value) || 10,
                maxHp: parseInt(document.getElementById('token-max-hp-input').value) || 10,
            };
            try {
                await mapDocRef.update({ [`tokens.${tokenId}`]: tokenData });
                document.getElementById('generic-token-modal').style.display = 'none';
            } catch (error) { console.error("Erro ao adicionar token:", error); }
        }

        function addPlayerTokenToMap(playerName, playerAvatar) {
            const tokenId = playerName;
            const tokenData = { name: playerName, avatar: playerAvatar, x: 0, y: 0, size: 1, color: '#64ffda' };
            mapDocRef.update({ [`tokens.${tokenId}`]: tokenData });
        }
        
        async function updateToken(tokenId, dataToUpdate) {
            const updates = {};
            for (const key in dataToUpdate) { updates[`tokens.${tokenId}.${key}`] = dataToUpdate[key]; }
            try { await mapDocRef.update(updates); } catch (e) { console.error("Erro ao atualizar token:", e); }
        }

        async function removeToken(tokenId) {
            try { await mapDocRef.update({ [`tokens.${tokenId}`]: firebase.firestore.FieldValue.delete() }); } 
            catch (e) { console.error("Erro ao remover o token:", e); }
        }

        function openTokenContextMenu(event, tokenEl, tokenData) {
            event.preventDefault();
            const menu = document.getElementById('token-context-menu');
            bringToFront(menu);
            menu.style.display = 'block';
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;
            const tokenId = tokenEl.dataset.name;

            document.getElementById('increase-token-size-btn').onclick = () => updateToken(tokenId, { size: (tokenData.size || 1) + 1 });
            document.getElementById('decrease-token-size-btn').onclick = () => updateToken(tokenId, { size: Math.max(1, (tokenData.size || 1) - 1) });
            const colorInput = document.getElementById('token-color-input');
            colorInput.value = tokenData.color || '#64ffda';
            colorInput.onchange = () => updateToken(tokenId, { color: colorInput.value });
            
            const hpEditor = document.getElementById('token-hp-editor');
            const hpSeparator = document.getElementById('token-hp-separator');
            if (tokenData.maxHp) {
                hpEditor.classList.remove('hidden');
                hpSeparator.classList.remove('hidden');
                const currentHpInput = document.getElementById('token-context-current-hp');
                const maxHpInput = document.getElementById('token-context-max-hp');
                currentHpInput.value = tokenData.currentHp;
                maxHpInput.value = tokenData.maxHp;
                document.getElementById('token-context-save-hp').onclick = () => {
                    updateToken(tokenId, { currentHp: parseInt(currentHpInput.value), maxHp: parseInt(maxHpInput.value) });
                    menu.style.display = 'none';
                };
            } else {
                hpEditor.classList.add('hidden');
                hpSeparator.classList.add('hidden');
            }

            document.getElementById('remove-token-btn').onclick = () => {
                if(confirm(`Remover o token de ${tokenData.name}?`)) removeToken(tokenId);
                menu.style.display = 'none';
            };
            const clickOutsideHandler = (e) => {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            setTimeout(() => document.addEventListener('click', clickOutsideHandler), 0);
        }

        function listenForMapChanges() {
            if (unsubscribeMapListener) unsubscribeMapListener();
            unsubscribeMapListener = mapDocRef.onSnapshot(doc => {
                const mapContainer = document.getElementById('map-container');
                const tokensContainer = document.getElementById('map-tokens');
                if (!doc.exists) {
                     mapContainer.style.backgroundImage = 'none';
                     mapContainer.style.width = `1000px`;
                     mapContainer.style.height = `1000px`;
                     tokensContainer.innerHTML = '';
                     return;
                }

                const mapData = doc.data();
                const mapWidth = mapData.width || 1000;
                const mapHeight = mapData.height || 1000;
                const gridSize = 50;
                mapContainer.style.width = `${mapWidth}px`;
                mapContainer.style.height = `${mapHeight}px`;
                mapContainer.style.backgroundImage = (mapData.background && mapData.background.src) ? `url('${mapData.background.src}')` : 'none';

                updateMapTransform();

                tokensContainer.innerHTML = '';
                const tokens = mapData.tokens || {};
                for (const tokenId in tokens) {
                    const tokenData = tokens[tokenId];
                    const tokenEl = document.createElement('div');
                    const tokenSizeInUnits = tokenData.size || 1;
                    const tokenPixelSize = tokenSizeInUnits * gridSize;
                    tokenEl.className = 'player-token';
                    tokenEl.style.left = `${tokenData.x}px`;
                    tokenEl.style.top = `${tokenData.y}px`;
                    tokenEl.style.width = `${tokenPixelSize}px`;
                    tokenEl.style.height = `${tokenPixelSize}px`;
                    tokenEl.style.backgroundImage = `url('${tokenData.avatar || 'https://placehold.co/50x50/0f223d/ccd6f6?text=?'
                    }')`;
                    tokenEl.style.borderColor = tokenData.color || 'var(--color-accent)';
                    tokenEl.dataset.name = tokenId;
                    
                    if(tokenData.maxHp) {
                        const hpBarContainer = document.createElement('div');
                        hpBarContainer.className = 'token-hp-bar-container';
                        const hpBar = document.createElement('div');
                        hpBar.className = 'token-hp-bar';
                        const percentage = tokenData.maxHp > 0 ? (tokenData.currentHp / tokenData.maxHp) * 100 : 0;
                        hpBar.style.width = `${percentage}%`;
                        hpBar.style.backgroundColor = percentage > 50 ? 'var(--color-green)' : percentage > 25 ? 'var(--color-yellow)' : 'var(--color-red)';
                        hpBarContainer.appendChild(hpBar);
                        tokenEl.appendChild(hpBarContainer);
                    }

                    const label = document.createElement('div');
                    label.className = 'token-label';
                    label.textContent = tokenData.name || tokenId;
                    tokenEl.appendChild(label);
                    tokensContainer.appendChild(tokenEl);

                    makeTokenDraggable(tokenEl, mapWidth, mapHeight, tokenPixelSize);
                    tokenEl.addEventListener('contextmenu', (e) => openTokenContextMenu(e, tokenEl, tokenData));
                }
            });
        }
        
        // --- FUNÇÃO CORRIGIDA PARA SUPORTE A PAN/ZOOM ---
        function makeTokenDraggable(tokenEl, mapWidth, mapHeight, tokenPixelSize) {
            let startMapX, startMapY, tokenStartX, tokenStartY;
            const gridSize = 50;

            // Função auxiliar para converter coordenadas do mouse (Tela) para coordenadas do Mapa (Dentro do Scale/Translate)
            const getMapCoordinates = (clientX, clientY) => {
                 const viewport = document.getElementById('map-viewport');
                 const rect = viewport.getBoundingClientRect();
                 const viewportMouseX = clientX - rect.left;
                 const viewportMouseY = clientY - rect.top;
                 
                 // Fórmula inversa do Transform: (Mouse - Translate) / Scale
                 return {
                     x: (viewportMouseX - mapTranslateX) / mapScale,
                     y: (viewportMouseY - mapTranslateY) / mapScale
                 };
            };

            const move = (e) => {
                e.preventDefault();
                if (!draggedToken) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const currentMapPos = getMapCoordinates(clientX, clientY);
                
                // Calcula nova posição baseada no Delta inicial
                let x = currentMapPos.x - startMapX + tokenStartX;
                let y = currentMapPos.y - startMapY + tokenStartY;

                // Mantém dentro do mapa
                x = Math.max(0, Math.min(mapWidth - tokenPixelSize, x));
                y = Math.max(0, Math.min(mapHeight - tokenPixelSize, y));

                draggedToken.style.left = `${x}px`;
                draggedToken.style.top = `${y}px`;
            };

            const startDrag = (e) => {
                if (e.button === 2) return; // Ignora botão direito
                e.stopPropagation(); // Impede que o Pan do mapa comece ao arrastar token

                draggedToken = tokenEl;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // Pega posição inicial no espaço do mapa
                const mapPos = getMapCoordinates(clientX, clientY);
                startMapX = mapPos.x;
                startMapY = mapPos.y;

                // Pega posição inicial do token
                tokenStartX = parseFloat(tokenEl.style.left) || 0;
                tokenStartY = parseFloat(tokenEl.style.top) || 0;

                window.addEventListener('mousemove', move);
                window.addEventListener('touchmove', move);
                window.addEventListener('mouseup', endDrag);
                window.addEventListener('touchend', endDrag);
            };

            const endDrag = () => {
                if (!draggedToken) return;
                
                // Snap to Grid (arredonda para o grid mais próximo)
                let x = Math.round(parseFloat(draggedToken.style.left) / gridSize) * gridSize;
                let y = Math.round(parseFloat(draggedToken.style.top) / gridSize) * gridSize;
                
                // Garante limites finais
                x = Math.max(0, Math.min(mapWidth - tokenPixelSize, x));
                y = Math.max(0, Math.min(mapHeight - tokenPixelSize, y));
                
                draggedToken.style.left = `${x}px`;
                draggedToken.style.top = `${y}px`;
                
                // Salva no Firebase
                updateToken(draggedToken.dataset.name, { x, y });
                
                draggedToken = null;
                window.removeEventListener('mousemove', move);
                window.removeEventListener('touchmove', move);
                window.removeEventListener('mouseup', endDrag);
                window.removeEventListener('touchend', endDrag);
            };

            tokenEl.addEventListener('mousedown', startDrag);
            tokenEl.addEventListener('touchstart', startDrag);
        }

        // --- GM PANEL FUNCTIONS ---
        function switchGmTab(event, tabName) {
            document.querySelectorAll('.gm-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.gm-tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        function listenForOnlinePlayers() {
            // Removido o filtro .where('last_seen') para mostrar todos os jogadores sempre
            playersCollection.onSnapshot(snapshot => {
                    const playerListEl = document.getElementById('gm-player-list');
                    playerListEl.innerHTML = snapshot.empty ? '<p class="text-secondary">Nenhum jogador encontrado.</p>' : '';
                    
                    // Converte para array para ordenar por nome em memória
                    const players = [];
                    snapshot.forEach(doc => players.push(doc.data()));
                    players.sort((a, b) => (a.charName || '').localeCompare(b.charName || ''));

                    players.forEach(player => {
                        const playerCard = document.createElement('div');
                        playerCard.className = 'gm-player-card';

                        const currentVigor = parseInt(player.vitals?.vigor || 0);
                        const fort = parseInt(player.attributes?.fortitude || 0);
                        const maxVigor = 6 + fort;
                        const percentage = maxVigor > 0 ? Math.max(0, Math.min(100, (currentVigor / maxVigor) * 100)) : 0;
                        let barColor = percentage > 50 ? 'var(--color-green)' : percentage > 25 ? 'var(--color-yellow)' : 'var(--color-red)';
                        
                        // Verifica se está online (últimos 5 min)
                        const lastSeen = player.last_seen ? player.last_seen.toDate() : new Date(0);
                        const isOnline = (Date.now() - lastSeen.getTime()) < 5 * 60 * 1000;
                        const statusDot = isOnline ? '🟢' : '⚫';
                        const statusTitle = isOnline ? 'Online' : 'Offline';

                        // avatarFicha: Usado no painel. É a imagem da ficha (grande) ou placeholder.
                        const avatarFicha = player.image || 'https://placehold.co/50x50/0f223d/ccd6f6?text=?';
                        // avatarToken: Usado no MAPA. É a imagem de combate (pequena/token) ou placeholder.
                        const avatarToken = player.combatImage || 'https://placehold.co/50x50/0f223d/ccd6f6?text=?';

                        // Se estiver offline, deixa o card um pouco mais transparente
                        if (!isOnline) playerCard.style.opacity = '0.7';

                        playerCard.innerHTML = `
                            <div class="gm-player-info">
                                <img src="${avatarFicha}" class="gm-player-avatar" alt="Avatar">
                                <div class="flex flex-col flex-grow">
                                    <span class="gm-player-name text-sm">${player.charName}</span>
                                    <span class="text-xs text-secondary" title="${statusTitle}">${statusDot} ${statusTitle}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="gm-control-btn" onclick="addPlayerTokenToMap('${player.charName}', '${avatarFicha}')" title="Adicionar ao Mapa">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/></svg>
                                    </button>
                                    <button class="gm-control-btn" onclick="openConditionModal('${player.charName}')" title="Atribuir Condições">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M4.402 4.145c.223.384.467.802.73 1.252.264.45.546.92.841 1.407l.076.125c.31.51.638.99.98 1.442l.01.014c.324.428.628.81.89 1.133l.09.108c.181.22.327.403.438.545.11-.142.257-.325.438-.545l.09-.108c.262-.323.566-.705.89-1.133l.01-.014c.342-.452.67-.932.98-1.442l.076-.125c.295-.488.577-1.002.842-1.407.263-.45.506-.868.73-1.252a6.51 6.51 0 0 1-1.23 1.062c-.432.32-.88.552-1.296.696l-.06.02a4.6 4.6 0 0 1-1.103.224c-.383.032-.753.02-1.098-.034a4.5 4.5 0 0 1-1.04-.328l-.068-.027c-.45-.188-.882-.48-1.266-.876a6.52 6.52 0 0 1-1.23-1.062h.01zm-3.195 9.71c.432-.32.88-.552 1.296-.696l.06-.02a4.6 4.6 0 0 1 1.103-.224c.383-.032.753-.02 1.098.034.345.054.706.154 1.04.328l.068.027c.45.188.882.48 1.266.876.385.395.71.848.985 1.353a6.51 6.51 0 0 1-1.23-1.062c-.432-.32-.88-.552-1.296-.696l-.06-.02a4.6 4.6 0 0 1-1.103-.224c-.383-.032-.753-.02-1.098-.034a4.5 4.5 0 0 1-1.04-.328l-.068-.027c-.45-.188-.882-.48-1.266-.876a6.52 6.52 0 0 1-1.23-1.062c.224.384.468.802.73 1.252.264.45.546.92.841 1.407.295.488.577 1.002.842 1.407.263.45.506-.868.73 1.252h.01z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="w-full h-6 bg-tertiary rounded-full relative overflow-hidden border border-color">
                                <div class="h-full rounded-full" style="width: ${percentage}%; background-color: ${barColor};"></div>
                                <span class="absolute inset-0 flex items-center justify-center font-bold text-white text-sm">${currentVigor} / ${maxVigor}</span>
                            </div>`;
                        playerListEl.appendChild(playerCard);
                    });
                }, error => {
                    console.error("Erro ao buscar jogadores online: ", error);
                    document.getElementById('gm-player-list').innerHTML = '<p class="text-red-400">Erro ao carregar jogadores.</p>';
                });
        }
        
        async function openConditionModal(charName) {
            const modal = document.getElementById('gm-condition-modal');
            modal.style.display = 'flex';
            bringToFront(modal);
            document.getElementById('gm-condition-modal-title').textContent = `Atribuir Condições para ${charName}`;
            const listEl = document.getElementById('gm-condition-list');
            listEl.innerHTML = 'Carregando...';
            const doc = await playersCollection.doc(charName).get();
            const currentConditions = doc.exists ? doc.data().conditions || [] : [];
            listEl.innerHTML = '';
            const conditions = Object.keys(allConditions).sort((a, b) => allConditions[a].name.localeCompare(allConditions[b].name));
            conditions.forEach(key => {
                const condition = allConditions[key];
                const isChecked = currentConditions.includes(key);
                const colorClass = condition.type === 'bonus' ? 'text-green-400' : 'text-red-400';
                listEl.innerHTML += `
                    <div class="flex items-center">
                        <input id="gm-cond-${key}" type="checkbox" class="hidden custom-checkbox" data-cond-key="${key}" ${isChecked ? 'checked' : ''}>
                        <label for="gm-cond-${key}" class="cursor-pointer select-none ${colorClass}">${condition.name}</label>
                    </div>`;
            });
            document.getElementById('gm-condition-save').onclick = () => savePlayerConditions(charName);
        }
        function closeConditionModal() { document.getElementById('gm-condition-modal').style.display = 'none'; }
        async function savePlayerConditions(charName) {
            const selectedConditions = Array.from(document.querySelectorAll('#gm-condition-list input:checked')).map(cb => cb.dataset.condKey);
            await playersCollection.doc(charName).update({ conditions: selectedConditions });
            closeConditionModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkFirebaseConfig();

            const viewport = document.getElementById('map-viewport');
            viewport.addEventListener('wheel', handleMapZoom, { passive: false });
            viewport.addEventListener('mousedown', handlePanStart);
            viewport.addEventListener('dblclick', handleMapPing);

            window.addEventListener('mousemove', handlePanMove);
            window.addEventListener('mouseup', handlePanEnd);
            window.addEventListener('mouseleave', handlePanEnd); 

            document.getElementById('add-token-btn').addEventListener('click', openGenericTokenModal);
            document.getElementById('new-map-btn').addEventListener('click', createNewMap);
            document.getElementById('change-bg-btn').addEventListener('click', openMapBgSourceModal);
            document.getElementById('map-bg-from-computer').addEventListener('click', () => { closeMapBgSourceModal(); document.getElementById('map-bg-upload').click(); });
            document.getElementById('map-bg-upload').addEventListener('change', handleMapBackgroundUpload);
            document.getElementById('map-bg-confirm').addEventListener('click', confirmMapBg);
            document.getElementById('map-bg-cancel').addEventListener('click', cancelMapBg);
            document.getElementById('gm-condition-cancel').addEventListener('click', closeConditionModal);
            
            document.getElementById('generic-token-cancel').addEventListener('click', () => { document.getElementById('generic-token-modal').style.display = 'none'; });
            document.getElementById('generic-token-confirm').addEventListener('click', createGenericToken);
            document.getElementById('token-image-upload').addEventListener('change', handleTokenImageUpload);
            document.getElementById('token-image-cancel').addEventListener('click', closeTokenImageAdjustModal);
            document.getElementById('token-image-confirm').addEventListener('click', confirmTokenImageCrop);

            const windows = document.querySelectorAll('.modal-overlay');
            windows.forEach(win => win.addEventListener('mousedown', () => bringToFront(win), true));
        });
    </script>
</body>
</html>