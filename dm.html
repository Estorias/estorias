<!DOCTYPE html>
<html lang="pt-BR" data-theme="cineria">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Jogadores - VTT</title><link rel="icon" type="image/x-icon" href="img/logo.ico">
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-bg: #0f0f0f;
            --color-secondary: #1a1a1a;
            --color-tertiary: #252525;
            --color-text: #e0e0e0;
            --color-text-secondary: #a0a0a0;
            --color-accent: #d4a373; /* Tom meio cobre/dourado */
            --color-border: #333333;
            --color-green: #4ade80;
            --color-red: #f87171;
            --font-main: 'Cinzel', serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: sans-serif;
        }

        h1, h2, h3, .font-condensed { font-family: var(--font-main); }
        .font-tech { font-family: var(--font-tech); }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-primary { background-color: var(--color-accent); color: #000; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--color-tertiary); color: var(--color-text); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background-color: var(--color-border); }
        .btn-danger { background-color: #7f1d1d; color: #fecaca; }
        .btn-danger:hover { background-color: #991b1b; }
        .btn-icon { padding: 0.25rem; border-radius: 9999px; transition: colors 0.2s; }
        .btn-icon:hover { background-color: rgba(255,255,255,0.1); color: var(--color-accent); }

        .card {
            background-color: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }

        .vigor-bar-bg { background-color: var(--color-tertiary); height: 1.5rem; border-radius: 9999px; overflow: hidden; position: relative; border: 1px solid var(--color-border); }
        .vigor-bar-fill { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; }
        .vigor-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: bold; text-shadow: 1px 1px 2px black; z-index: 10; }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7);
            display: none; align-items: center; justify-content: center; z-index: 50;
        }
        .modal-container {
            background-color: var(--color-secondary);
            border: 1px solid var(--color-border);
            max-width: 600px; width: 95%; max-height: 90vh;
            overflow-y: auto; border-radius: 0.5rem; padding: 1.5rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-accent); }
        
        .custom-checkbox:checked + label { color: var(--color-accent); font-weight: bold; }
    </style>
</head>
<body class="p-4 sm:p-6">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 max-w-7xl mx-auto gap-4">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--color-accent);">Gestão de Jogadores</h1>
            <p class="text-sm" style="color: var(--color-text-secondary);">Painel dedicado para combate e monitoramento.</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="reset-session-btn" onclick="resetAndSync()" class="btn btn-danger text-sm flex items-center gap-2" title="Limpar lista e pedir dados aos players">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                <span>Resetar Sessão</span>
            </button>
            <div id="connection-status" class="px-3 py-1 rounded-full text-xs font-bold bg-red-900 text-red-200 whitespace-nowrap">
                Desconectado
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto">
        <!-- Grid de Jogadores -->
        <div id="players-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="col-span-full text-center py-10 animate-pulse text-gray-500">Carregando dados da mesa...</p>
        </div>
    </main>

    <!-- Modal de Condições -->
    <div id="condition-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--color-border);">
                <h3 id="condition-modal-title" class="text-xl font-bold font-condensed" style="color: var(--color-accent);">Condições</h3>
                <button onclick="closeModal('condition-modal')" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="condition-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-6 text-sm"></div>
            <div class="flex justify-end gap-3 border-t border-gray-700 pt-4">
                <button onclick="closeModal('condition-modal')" class="btn btn-secondary">Cancelar</button>
                <button id="save-condition-btn" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagem Privada -->
    <div id="private-msg-modal" class="modal-overlay">
        <div class="modal-container">
            <h3 class="text-xl font-bold mb-4 font-condensed" style="color: var(--color-accent);">Sussurro</h3>
            <p id="private-msg-target" class="text-sm mb-4 text-gray-400">Enviando para: ...</p>
            <textarea id="private-msg-input" class="w-full p-3 rounded bg-black border border-gray-700 text-white mb-4 h-32 focus:outline-none focus:border-yellow-600" placeholder="Digite a mensagem secreta..."></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('private-msg-modal')" class="btn btn-secondary">Cancelar</button>
                <button id="send-msg-btn" class="btn btn-primary">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS GLOBAIS ---
        let db, playersCollection, messagesCollection;
        let currentEditingPlayer = null;
        
        // LISTA ATUALIZADA (Sincronizada com script.js mais recente)
        const allConditions = {
            'protegido': { name: 'Protegido (x)', type: 'bonus' }, 
            'vantagem': { name: 'Vantagem', type: 'bonus'}, 
            'inspirado': { name: 'Inspirado', type: 'bonus' },
            'focado': { name: 'Focado', type: 'bonus' },
            'fortalecido': { name: 'Fortalecido', type: 'bonus' },
            'impetuoso': { name: 'Impetuoso', type: 'bonus' },
            'agilizado': { name: 'Agilizado', type: 'bonus' },
            'preparado': { name: 'Preparado', type: 'bonus' },
            'revitalizado': { name: 'Revitalizado', type: 'bonus' },
            'motivado': { name: 'Motivado', type: 'bonus' },
            'destemido': { name: 'Destemido', type: 'bonus' },
            
            'vulneravel': { name: 'Vulnerável (x)', type: 'onus' },
            'desmotivado': { name: 'Desmotivado', type: 'onus' },
            'enfraquecido': { name: 'Enfraquecido', type: 'onus' },
            'lento': { name: 'Lento', type: 'onus' },
            'desvantagem': { name: 'Desvantagem', type: 'onus' },
            'em-apuros': { name: 'Em apuros', type: 'onus' },
            'preso': { name: 'Preso', type: 'onus' },
            'cansado': { name: 'Cansado', type: 'onus' },
            'desorientado': { name: 'Desorientado', type: 'onus' },
            'assustado': { name: 'Assustado', type: 'onus' },
            'ferido': { name: 'Ferido', type: 'onus' },
            'baixa-visibilidade': { name: 'Baixa Visibilidade', type: 'onus' },
            
            'apavorado': { name: 'Apavorado', type: 'condition' },
            'gravemente-ferido': { name: 'Gravemente Ferido', type: 'condition' },
            'exausto': { name: 'Exausto', type: 'condition' },
            'incapacitado': { name: 'Incapacitado', type: 'condition' },
            'cego': { name: 'Cego', type: 'condition' },
            'impedido': { name: 'Impedido', type: 'condition' },
            'epifania': { name: 'Epifania', type: 'condition' },
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedConfig = localStorage.getItem('rpg_firebase_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(config);
                    }
                    db = firebase.firestore();
                    playersCollection = db.collection('players');
                    messagesCollection = db.collection('chat_messages');
                    
                    updateStatus(true);
                    listenForPlayers();
                } catch (e) {
                    console.error(e);
                    alert("Erro ao conectar com Firebase. Verifique se você configurou a mesa no arquivo principal (pm.html).");
                    updateStatus(false);
                }
            } else {
                document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-center flex-col gap-4"><h1>Configuração não encontrada</h1><p>Por favor, configure o Firebase primeiro no Painel do Mestre (pm.html) ou Ficha do Player.</p></div>';
            }
        });

        function updateStatus(online) {
            const el = document.getElementById('connection-status');
            if(online) {
                el.textContent = "Conectado";
                el.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-900 text-green-200 border border-green-700 whitespace-nowrap";
            } else {
                el.textContent = "Erro de Conexão";
                el.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-900 text-red-200 border border-red-700 whitespace-nowrap";
            }
        }

        // --- RESETAR SESSÃO ---
        async function resetAndSync() {
            if (!db) return;
            if (!confirm("Isso apagará a lista de jogadores e solicitará que as fichas ONLINE enviem seus dados novamente.\n\nÚtil para limpar 'fantasmas' ou erros de sincronização.\nDeseja continuar?")) return;

            const btn = document.getElementById('reset-session-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>Limpando...</span>`;
            btn.disabled = true;

            try {
                const snapshot = await playersCollection.get();
                if (!snapshot.empty) {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }

                btn.innerHTML = `<span>Aguardando...</span>`;
                await new Promise(resolve => setTimeout(resolve, 2000));

                await db.collection('game_state').doc('sync_signal').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    action: 'force_refresh_all'
                });

                btn.innerHTML = `<span>Sinal Enviado!</span>`;
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1500);

            } catch (error) {
                console.error("Erro ao resetar sessão:", error);
                alert("Ocorreu um erro ao tentar resetar. Verifique o console.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- LISTENER DE PLAYERS ---
        function listenForPlayers() {
            const timeFilter = new Date(Date.now() - (60 * 60 * 1000));

            playersCollection.orderBy('charName').onSnapshot(snapshot => {
                const grid = document.getElementById('players-grid');
                grid.innerHTML = '';
                
                if (snapshot.empty) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">Nenhum jogador online.<br><span class="text-xs">Clique em "Resetar Sessão" se acha que isso é um erro.</span></p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const p = doc.data();
                    const card = createPlayerCard(p);
                    grid.appendChild(card);
                });
            });
        }

        function createPlayerCard(player) {
            const div = document.createElement('div');
            div.className = 'card p-4 flex flex-col gap-4';

            const max = player.maxVigor || 10;
            const current = player.vigor !== undefined ? player.vigor : 10;
            const pct = Math.max(0, Math.min(100, (current / max) * 100));
            
            let barColor = 'var(--color-green)';
            if(pct <= 50) barColor = 'var(--color-accent)';
            if(pct <= 25) barColor = 'var(--color-red)';

            // Renderização de Condições
            let conditionsHtml = '';
            if (player.conditions && player.conditions.length > 0) {
                conditionsHtml = `<div class="flex flex-wrap gap-1 mt-2">
                    ${player.conditions.map(c => {
                        const info = allConditions[c];
                        let color = 'text-gray-400 border-gray-700 bg-gray-900/50';
                        if (info) {
                            if (info.type === 'bonus') color = 'text-green-400 border-green-900 bg-green-900/20';
                            else if (info.type === 'onus') color = 'text-red-400 border-red-900 bg-red-900/20';
                            else if (info.type === 'condition') color = 'text-yellow-400 border-yellow-900 bg-yellow-900/20';
                        }
                        return `<span class="text-xs px-2 py-0.5 rounded border ${color}">${info ? info.name.split(' (')[0] : c}</span>`;
                    }).join('')}
                </div>`;
            } else {
                conditionsHtml = `<div class="mt-2 text-xs italic text-gray-600">Sem condições ativas</div>`;
            }

            div.innerHTML = `
                <div class="flex items-start gap-4">
                    <img src="${player.avatar || 'https://placehold.co/80x80/222222/888888?text=?'}" 
                         class="w-20 h-20 rounded object-cover border border-gray-700 shadow-sm flex-shrink-0">
                    
                    <div class="flex-grow min-w-0">
                        <h3 class="text-xl font-bold truncate text-white leading-tight">${player.charName}</h3>
                        <p class="text-xs text-gray-500 mb-2 truncate">${player.playerName || 'Jogador'}</p>
                        
                        <!-- Barra de Vigor -->
                        <div class="vigor-bar-bg w-full">
                            <div class="vigor-bar-fill" style="width: ${pct}%; background-color: ${barColor};"></div>
                            <span class="vigor-text text-white drop-shadow-md">${current} / ${max}</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Condições -->
                <div class="border-t border-gray-800 pt-2 min-h-[3rem]">
                    ${conditionsHtml}
                </div>

                <!-- Botões de Ação -->
                <div class="grid grid-cols-4 gap-2 mt-auto">
                    <button onclick="changeVigor('${player.charName}', -1)" class="btn btn-secondary text-red-400 font-bold text-lg" title="-1 Vigor">-</button>
                    <button onclick="changeVigor('${player.charName}', 1)" class="btn btn-secondary text-green-400 font-bold text-lg" title="+1 Vigor">+</button>
                    <button onclick="openConditions('${player.charName}')" class="btn btn-secondary" title="Gerir Condições">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 011.414.586l4 4a1 1 0 01.586 1.414V19a2 2 0 01-2 2z" /></svg>
                    </button>
                    <button onclick="openPrivateMsg('${player.charName}')" class="btn btn-secondary" title="Mensagem Privada">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                    </button>
                </div>
            `;
            return div;
        }

        // --- LÓGICA DE VIGOR ---
        async function changeVigor(charName, amount) {
            const ref = playersCollection.doc(charName);
            try {
                await db.runTransaction(async (t) => {
                    const doc = await t.get(ref);
                    if (!doc.exists) return;
                    const data = doc.data();
                    let newV = (data.vigor || 0) + amount;
                    if (newV < 0) newV = 0;
                    if (newV > data.maxVigor) newV = data.maxVigor;
                    t.update(ref, { vigor: newV });
                });
            } catch (e) { console.error("Erro vigor:", e); }
        }

        // --- LÓGICA DE CONDIÇÕES ---
        async function openConditions(charName) {
            currentEditingPlayer = charName;
            const modal = document.getElementById('condition-modal');
            const title = document.getElementById('condition-modal-title');
            const list = document.getElementById('condition-list');
            
            title.textContent = `Condições: ${charName}`;
            list.innerHTML = '<p class="text-center text-gray-500 col-span-2">Carregando...</p>';
            modal.style.display = 'flex';

            try {
                const doc = await playersCollection.doc(charName).get();
                if(!doc.exists) {
                    closeModal('condition-modal');
                    return;
                }
                
                const active = doc.data().conditions || [];
                list.innerHTML = '';

                // Ordenar condições alfabeticamente
                Object.keys(allConditions).sort().forEach(key => {
                    const info = allConditions[key];
                    const isActive = active.includes(key);
                    
                    let colorClass = 'text-gray-400';
                    if (info.type === 'bonus') colorClass = 'text-green-400';
                    else if (info.type === 'onus') colorClass = 'text-red-400';
                    else if (info.type === 'condition') colorClass = 'text-yellow-400';
                    
                    const item = document.createElement('div');
                    item.className = 'flex items-center p-2 rounded hover:bg-white/5';
                    item.innerHTML = `
                        <input type="checkbox" id="cond-${key}" class="custom-checkbox w-4 h-4 mr-3 rounded border-gray-600 bg-gray-700 text-yellow-600 focus:ring-offset-gray-800" ${isActive ? 'checked' : ''}>
                        <label for="cond-${key}" class="cursor-pointer select-none flex-grow ${colorClass}">${info.name}</label>
                    `;
                    list.appendChild(item);
                });

                document.getElementById('save-condition-btn').onclick = () => saveConditions(charName);

            } catch(e) { console.error(e); }
        }

        async function saveConditions(charName) {
            const btn = document.getElementById('save-condition-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            const checkboxes = document.querySelectorAll('#condition-list input[type="checkbox"]');
            const selected = [];
            checkboxes.forEach(cb => {
                if(cb.checked) selected.push(cb.id.replace('cond-', ''));
            });

            try {
                await playersCollection.doc(charName).update({ conditions: selected });
                closeModal('condition-modal');
            } catch(e) { 
                console.error(e);
                alert("Erro ao salvar condições."); 
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // --- LÓGICA DE CHAT PRIVADO ---
        function openPrivateMsg(charName) {
            currentEditingPlayer = charName;
            document.getElementById('private-msg-target').textContent = `Enviando sussurro para: ${charName}`;
            document.getElementById('private-msg-input').value = '';
            document.getElementById('private-msg-modal').style.display = 'flex';
            document.getElementById('private-msg-input').focus();
            
            document.getElementById('send-msg-btn').onclick = sendPrivateMessage;
        }

        async function sendPrivateMessage() {
            const text = document.getElementById('private-msg-input').value.trim();
            if (!text) return;

            try {
                await messagesCollection.add({
                    text: text,
                    sender: 'Mestre', 
                    avatar: 'https://placehold.co/40x40/d4a373/1a1a1a?text=GM',
                    isSystem: false,
                    isPrivate: true,
                    recipient: currentEditingPlayer,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('private-msg-modal');
            } catch (e) {
                console.error(e);
                alert("Erro ao enviar mensagem.");
            }
        }

        // --- UTILITÁRIOS ---
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>